Index: database/processing/historical_index_insert.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import datetime\r\nimport connect\r\nimport json\r\nimport traceback\r\n\r\nfrom sqlalchemy import text\r\nfrom sqlalchemy.exc import IntegrityError\r\n\r\ndef load_output_file(path):\r\n    try:\r\n        with open(path, \"r\") as output_file:\r\n            output_data = json.load(output_file)\r\n        return output_data\r\n    except FileNotFoundError:\r\n        print(f\"Output file '{path}' not found.\")\r\n        exit(1)\r\n    except json.JSONDecodeError:\r\n        print(f\"Error decoding JSON in '{path}'\")\r\n        exit(1)\r\n\r\ndef main():\r\n    # Load json data\r\n    historical_data = load_output_file('./data_collection/output/raw_historical_index_output.json')\r\n\r\n    try:\r\n        # create with context manager\r\n        with connect.connect() as conn:\r\n            for entry in historical_data:\r\n                symbol = entry['symbol']\r\n\r\n                # check if index exists in indexes table\r\n                result = conn.execute(text(f\"SELECT id FROM `indexes` WHERE symbol = '{symbol}'\"))\r\n                row = result.one_or_none()\r\n\r\n                if row is None:\r\n                    # execute plain sql insert statement - trigger will fire\r\n\r\n                    # small issue here, name is not included in histrocial output:\r\n                        # 'name' field may need to be appended to ouput or we make an API call here\r\n                    conn.execute(text(f\"INSERT INTO `indexes`(`indexname`, `symbol`) VALUES ('test', '{symbol}')\"))\r\n                    conn.commit()\r\n\r\n                    # get id generated from trigger\r\n                    result = conn.execute(text(f\"SELECT id FROM `indexes` WHERE symbol = '{symbol}'\")) \r\n                    index_id = result.one()[0]\r\n                else:\r\n                    index_id = row[0]\r\n                    \r\n                # process historical data\r\n                # NOTE: entry keys will need to be changed to be inline with new output names\r\n                for obj in range(len(entry['historical'])):\r\n                    date = entry['historical'][obj]['date']\r\n                    index_open = entry['historical'][obj]['open']\r\n                    high = entry['historical'][obj]['high']\r\n                    low = entry['historical'][obj]['low']\r\n                    close = entry['historical'][obj]['close']\r\n                    adj_close = entry['historical'][obj]['adjClose']\r\n                    volume = entry['historical'][obj]['volume']\r\n                    unadjusted_volume = entry['historical'][obj]['unadjustedVolume']\r\n                    change = entry['historical'][obj]['change']\r\n                    change_percentage = entry['historical'][obj]['changePercent']\r\n                    vwap = entry['historical'][obj]['vwap']\r\n                    change_over_time = entry['historical'][obj]['changeOverTime']\r\n                \r\n                    try:\r\n                        # Excute row insertion\r\n                        conn.execute(text(f\"INSERT INTO `historical_index_values` VALUES ('{index_id}', '{date}', '{index_open}', '{high}', '{low}', '{close}','{adj_close}', '{volume}', '{unadjusted_volume}', '{change}', '{change_percentage}', '{vwap}', '{change_over_time}')\"))\r\n                        conn.commit()\r\n                    except IntegrityError as e:\r\n                        continue\r\n                \r\n    except Exception as e:\r\n        print(e)\r\n        print(traceback.format_exc())\r\n        print(\"SQL connection error\")\r\n\r\n# protected entrypoint\r\nif __name__ == \"__main__\":\r\n    main()
===================================================================
diff --git a/database/processing/historical_index_insert.py b/database/processing/historical_index_insert.py
--- a/database/processing/historical_index_insert.py	
+++ b/database/processing/historical_index_insert.py	
@@ -64,7 +64,9 @@
                 
                     try:
                         # Excute row insertion
-                        conn.execute(text(f"INSERT INTO `historical_index_values` VALUES ('{index_id}', '{date}', '{index_open}', '{high}', '{low}', '{close}','{adj_close}', '{volume}', '{unadjusted_volume}', '{change}', '{change_percentage}', '{vwap}', '{change_over_time}')"))
+                        conn.execute(text(f"INSERT INTO `historical_index_values` VALUES ('{index_id}', '{date}', '{index_open}', '{high}', "
+                                          f"'{low}', '{close}','{adj_close}', '{volume}', '{unadjusted_volume}', '{change}', "
+                                          f"'{change_percentage}', '{vwap}', '{change_over_time}')"))
                         conn.commit()
                     except IntegrityError as e:
                         continue
